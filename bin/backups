#!/bin/bash


function backdfckup() {
  fmt="$(date +%F.%T)"
  BACKUP_FOLDER="$HOME/backups"
    # $1 ssh host
    # $2 DB NAME
    FILE="$BACKUP_FOLDER/$2.${fmt}.sql"
    ssh $1 "mysqldump -y $2 | gzip -c" | gzip -cd > $FILE  && du -h "$FILE"
}

export -f backdfckup

date

# Keys to add to ssh-agent
#eval "$(ssh-agent -s)"

# Add keys here
# for key in ~/.ssh/novosoui; do
#     ssh-add $key
# done

cd ~/backups

parallel ::: "backdfckup cosmoethos cosmo095_ethos" \
  "backdfckup pds@uniamerica.br pds" \
  "backdfckup uniamerica@uniamerica.br uniamerica" \
  "backdfckup urcamp@do urcamp" \
  "backdfckup ucv@do ucv" \
  "backdfckup happyturtle agendapositiva"

# ENCRYPT / SEND
if [[ $(date +%H) -gt 12 ]]; then
    PERIOD=2
else
    PERIOD=1
fi

BCKFILE="backup.$(date +%F).$PERIOD.tgz"

echo $BCKFILE

ls -a | grep "$(date +%F)" | xargs tar czf $BCKFILE

gpg --encrypt --recipient dnlcorrea@gmail.com $BCKFILE

rclone copy -P $BCKFILE.gpg drive:backups
mv $BCKFILE.gpg ~/Dropbox/backups
rm $BCKFILE

echo done

############################

echo "Backing up documents"

## Servers

BACKUP_FOLDER="$HOME/backups/docs"

parallel rsync -urzzv ::: "ucv@do:storage $BACKUP_FOLDER/ucv" \
    "urcamp@do:storage $BACKUP_FOLDER/urcamp" \
    "pds@uniamerica.br:storage $BACKUP_FOLDER/pds"

## Backup site Uniamerica
rsync -rzzuv uniamerica@uniamerica.br:{public,storage} $HOME/www/uniamerica
